<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Transférer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        /* Keep existing visual style */
        .primary-btn{background:#2E7CF6;border:none;}
        .app-header .brand{font-weight:600;}
        .app-header .nav-link{color:#212529; padding:0;}
        .app-header .nav-link:hover{color:#0d6efd;}
        .app-header .nav-link.active{color:#2E7CF6; font-weight:600;}
        .form-select, .form-control { height: 48px; }
        .input-group-text { height: 48px; }
        select.form-select:has(option[value=""]:checked) { color:#6c757d; }
        select.form-select option { color:#212529; }
    </style>
</head>
<body class="bg-light">

<!-- Top navigation + logout -->
<header class="app-header container py-3">
    <div class="d-flex justify-content-between align-items-center">
        <div class="brand">Pay My Buddy</div>
        <nav class="d-flex gap-4">
            <!-- Dashboard (GET /transfer) -->
            <a th:href="@{/transfer}" class="nav-link active">Transférer</a>
            <a th:href="@{/profile}" class="nav-link">Profil</a>
            <a th:href="@{/connections}" class="nav-link">Ajouter relation</a>

            <!-- Logout (POST /logout) with CSRF -->
            <form th:action="@{/logout}" method="post" class="d-inline m-0 p-0">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button type="submit" class="btn btn-link nav-link p-0">Se déconnecter</button>
            </form>
        </nav>
    </div>
</header>

<!-- Flash messages injected by controllers (success/error) -->
<div th:replace="~{fragments/flash :: body}"></div>

<main class="container py-4">

    <!-- Balance + TopUp/Withdraw form (single endpoint: POST /transfer) -->
    <section class="card border-0 shadow-sm mb-4">
        <div class="card-body d-flex flex-wrap align-items-end justify-content-between gap-3">
            <div>
                <div class="text-muted small">Solde disponible</div>
                <!-- Display user's wallet balance with 2 decimals -->
                <div class="h4 m-0" th:text="${#numbers.formatDecimal(me.balance, 1, 'COMMA', 2, 'POINT')} + ' €'">0,00 €</div>
            </div>

            <!-- Same layout; two submit buttons decide the operation via name=type -->
            <form class="d-flex gap-2" th:action="@{/transfer}" method="post">
                <!-- CSRF token required for POST -->
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                <!-- Amount input (server also validates min/rounding) -->
                <div class="input-group">
                    <input class="form-control" name="amount" type="number" step="0.01" min="0.01" placeholder="Montant" required />
                    <span class="input-group-text">€</span>
                </div>

                <!-- TOP_UP (wallet deposit) -->
                <button class="btn btn-outline-success" type="submit" name="type" value="TOP_UP">Recharge</button>

                <!-- WITHDRAWAL (to bank) -->
                <button class="btn btn-outline-danger"  type="submit" name="type" value="WITHDRAWAL">Retrait</button>
            </form>
        </div>
    </section>

    <!-- P2P transfer form (no 'type' param => controller treats as P2P) -->
    <form class="row g-3 align-items-center mb-5"
          th:action="@{/transfer}" method="post" th:object="${transferForm}">
        <!-- CSRF token -->
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

        <!-- Receiver from friends list (value = email) -->
        <div class="col-12 col-md-4">
            <label class="form-label visually-hidden">Relation</label>
            <select class="form-select" th:field="*{receiverEmail}" required>
                <!-- Placeholder option -->
                <option value=""
                        th:selected="${transferForm == null or #strings.isEmpty(transferForm.receiverEmail)}">
                    Sélectionner une relation
                </option>

                <!-- Show username if present, otherwise email -->
                <option th:each="f : ${friends}"
                        th:value="${f.email}"
                        th:text="${#strings.isEmpty(f.username) ? f.email : f.username}">
                </option>
            </select>
        </div>

        <!-- Optional description -->
        <div class="col-12 col-md-4">
            <label class="form-label visually-hidden">Description</label>
            <input class="form-control" th:field="*{description}" placeholder="Description (optionnel)" maxlength="100"/>
        </div>

        <!-- Amount (>= 0.01) -->
        <div class="col-8 col-md-2">
            <label class="form-label visually-hidden">Montant (€)</label>
            <div class="input-group">
                <input class="form-control" th:field="*{amount}" type="number" step="0.01" min="0.01" placeholder="0" required/>
                <span class="input-group-text">€</span>
            </div>
        </div>

        <!-- Submit P2P -->
        <div class="col-4 col-md-2 d-grid">
            <button class="btn btn-primary primary-btn" type="submit">Payer</button>
        </div>
    </form>

    <!-- Transactions history (signed amount computed relative to 'me') -->
    <section class="card border-0 shadow-sm">
        <div class="card-body">
            <h2 class="h6 mb-3">Mes Transactions</h2>
            <div class="table-responsive">
                <table class="table align-middle">
                    <thead>
                    <tr>
                        <th>Relations</th>
                        <th>Description</th>
                        <th class="text-end">Montant</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- For each tx, derive counterparty label and signed amount -->
                    <tr th:each="tx : ${feed}"
                        th:with="
                        isSender = ${tx.sender != null and me != null and tx.sender.id == me.id},
                        isReceiver = ${tx.receiver != null and me != null and tx.receiver.id == me.id},

                        isTopUp = ${tx.type == T(com.openclassrooms.payMyBuddy.model.TransactionType).TOP_UP},
                        isP2P = ${tx.type == T(com.openclassrooms.payMyBuddy.model.TransactionType).P2P_TRANSFER},
                        isWithdrawal = ${tx.type == T(com.openclassrooms.payMyBuddy.model.TransactionType).WITHDRAWAL},

                        counterparty=${
                            isTopUp ? 'Rechargement'
                                : (isWithdrawal ? 'Retrait bancaire'
                                    : ( isSender
                                        ? (tx.receiver != null ? (#strings.isEmpty(tx.receiver.username) ? tx.receiver.email : tx.receiver.username) : '-')
                                        : (tx.sender != null ? (#strings.isEmpty(tx.sender.username) ? tx.sender.email : tx.sender.username) : '-')
                                    )
                                )
                        },

                        signedAmount=${
                            isTopUp     ? (isReceiver ? tx.netAmount : 0)
                            : (isP2P    ? (isSender ? (tx.grossAmount.add(tx.feeAmount).negate()) : tx.grossAmount)
                            : (isWithdrawal ? (isSender ? (tx.grossAmount.add(tx.feeAmount).negate()) : 0)
                            : 0))
                        }
">
                        <!-- Counterparty / action label -->
                        <td th:text="${counterparty}">-</td>

                        <!-- Description or '-' -->
                        <td th:text="${(tx.description != null and !#strings.isEmpty(tx.description)) ? tx.description : '-'}">-</td>

                        <!-- Signed amount: red negative / green positive -->
                        <td class="text-end">
                            <span th:classappend="${signedAmount < 0} ? 'text-danger' : 'text-success'">
                              <span th:text="${#numbers.formatDecimal(signedAmount, 1, 'COMMA', 2, 'POINT')}">0,00</span> €
                            </span>
                        </td>
                    </tr>

                    <!-- Empty state -->
                    <tr th:if="${#lists.isEmpty(feed)}">
                        <td colspan="3" class="text-muted">Aucune transaction.</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
