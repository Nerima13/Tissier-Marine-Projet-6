<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Transférer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        .primary-btn{background:#2E7CF6;border:none;}
        .app-header .brand{font-weight:600;}
        .app-header .nav-link{color:#212529; padding:0;}
        .app-header .nav-link:hover{color:#0d6efd;}
        .app-header .nav-link.active{color:#2E7CF6; font-weight:600;}
        .form-select, .form-control { height: 48px; }
        .input-group-text { height: 48px; }
        select.form-select:has(option[value=""]:checked) { color:#6c757d; }
        select.form-select option { color:#212529; }
    </style>
</head>
<body class="bg-light">

<!-- Header -->
<header class="app-header container py-3">
    <div class="d-flex justify-content-between align-items-center">
        <div class="brand">Pay My Buddy</div>
        <nav class="d-flex gap-4">
            <a th:href="@{/transfer}" class="nav-link active">Transférer</a>
            <a th:href="@{/profile}" class="nav-link">Profil</a>
            <a th:href="@{'/transfer#add'}" class="nav-link">Ajouter relation</a>

            <!-- Déconnexion (POST /logout) -->
            <form th:action="@{/logout}" method="post" class="d-inline m-0 p-0">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button type="submit" class="btn btn-link nav-link p-0">Se déconnecter</button>
            </form>
        </nav>
    </div>
</header>

<!-- Flash messages -->
<div th:replace="~{fragments/flash :: body}"></div>

<main class="container py-4">
    <!-- Money transfer form -->
    <form class="row g-3 align-items-center mb-5"
          th:action="@{/transfer}" method="post" th:object="${transferForm}">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <div class="col-12 col-md-4">
            <label class="form-label visually-hidden">Relation</label>
            <select class="form-select" th:field="*{receiverEmail}" required>
                <!-- Placeholder shown when no recipient is selected -->
                <option value=""
                        th:selected="${transferForm == null or #strings.isEmpty(transferForm.receiverEmail)}">
                    Sélectionner une relation
                </option>

                <option th:each="f : ${friends}"
                        th:value="${f.email}"
                        th:text="${#strings.isEmpty(f.username) ? f.email : f.username}">
                </option>
            </select>
        </div>
        <div class="col-12 col-md-4">
            <label class="form-label visually-hidden">Description</label>
            <input class="form-control" th:field="*{description}" placeholder="Description (optionnel)" maxlength="100"/>
        </div>
        <div class="col-8 col-md-2">
            <label class="form-label visually-hidden">Montant (€)</label>
            <div class="input-group">
                <input class="form-control" th:field="*{amount}" type="number" step="0.01" min="0.01" placeholder="0" required/>
                <span class="input-group-text">€</span>
            </div>
        </div>
        <div class="col-4 col-md-2 d-grid">
            <button class="btn btn-primary primary-btn" type="submit">Payer</button>
        </div>
    </form>

    <!-- Transactions history -->
    <section class="card border-0 shadow-sm">
        <div class="card-body">
            <h2 class="h6 mb-3">Mes Transactions</h2>
            <div class="table-responsive">
                <table class="table align-middle">
                    <thead>
                    <tr>
                        <th>Relations</th>
                        <th>Description</th>
                        <th class="text-end">Montant</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- Relies on 'me' (provided by the controller) -->
                    <tr th:each="tx : ${feed}"
                        th:with="
                            isSender=${ tx.sender != null
                                       and me != null
                                       and !(tx.sender instanceof T(java.lang.String))
                                       and (tx.sender.id == me.id) },
                            other=${isSender} ? ${tx.receiver} : ${tx.sender},
                            displayName=${
                              other == null
                                ? '-'
                                : ( other instanceof T(java.lang.String)
                                    ? other
                                    : ( !#strings.isEmpty(other.username)
                                        ? other.username
                                        : (other.email != null ? other.email : '-') )
                                  )
                            }">
                        <td th:text="${displayName}">Relation</td>
                        <td th:text="${(tx.description != null and !#strings.isEmpty(tx.description)) ? tx.description : '-'}">-</td>
                        <td class="text-end">
                            <span th:text="${#numbers.formatDecimal(tx.amount, 1, 'COMMA', 2, 'POINT')}">0.00</span> €
                        </td>
                    </tr>

                    <tr th:if="${#lists.isEmpty(feed)}">
                        <td colspan="3" class="text-muted">Aucune transaction.</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
